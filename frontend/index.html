<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AoE IV AI Coach</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
            .header p {
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .input-section {
            background: #16213e;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .input-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .input-field {
            flex: 1;
            min-width: 200px;
        }
        
        .input-field label {
            display: block;
            margin-bottom: 0.5rem;
            color: #a0a0a0;
            font-size: 0.9rem;
        }
        
        .input-field input,
        .input-field select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #0f3460;
            border-radius: 8px;
            background: #0f3460;
            color: #fff;
            font-size: 1rem;
        }
        
        .input-field input:focus,
        .input-field select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #764ba2;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid #667eea;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
        }
        
        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .rating {
            font-size: 4rem;
            font-weight: bold;
            text-align: center;
            color: #f39c12;
            margin: 1rem 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .stat-box {
            background: #0f3460;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box h3 {
            font-size: 0.85rem;
            color: #a0a0a0;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .stat-box .value {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
        }
        
        .stat-box .sub {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.25rem;
        }
        
        .improvement-item {
            background: #0f3460;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #e74c3c;
        }
        
        .improvement-item h4 {
            color: #e74c3c;
            margin-bottom: 0.5rem;
        }
        
        .strength-item {
            background: #0f3460;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid #27ae60;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        .games-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .game-item {
            background: #0f3460;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-item.win {
            border-left: 4px solid #27ae60;
        }
        
        .game-item.loss {
            border-left: 4px solid #e74c3c;
        }
        
        .game-info h4 {
            margin-bottom: 0.25rem;
        }
        
        .game-info p {
            font-size: 0.85rem;
            color: #888;
        }
        
        .game-result {
            text-align: right;
        }
        
        .game-result .result {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .game-result .result.win {
            color: #27ae60;
        }
        
        .game-result .result.loss {
            color: #e74c3c;
        }
        
        .game-result .rating {
            font-size: 0.85rem;
            color: #888;
            margin-top: 0.25rem;
        }
        
        .help-text {
            font-size: 0.85rem;
            color: #888;
            margin-top: 0.5rem;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .player-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .player-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #0f3460;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        
        .player-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .player-info h3 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        
        .player-info p {
            color: #888;
        }

        .build-order-view {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #0f3460;
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .game-header-left {
            flex: 1;
        }

        .game-header-right {
            text-align: right;
        }

        .matchup {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            justify-content: center;
        }

        .matchup-player {
            text-align: center;
            flex: 1;
            max-width: 300px;
        }

        .matchup-vs {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .build-order-timeline {
            max-height: 600px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .build-order-item {
            background: #0f3460;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #667eea;
        }

        .build-order-item:nth-child(even) {
            background: #16213e;
        }

        .build-order-time {
            font-weight: bold;
            color: #667eea;
            min-width: 60px;
        }

        .build-order-action {
            flex: 1;
            padding: 0 1rem;
        }

        .build-order-count {
            color: #888;
            font-size: 0.9rem;
        }

        .warning {
            background: #f39c12;
            color: #1a1a2e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .build-order-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .build-order-container {
                grid-template-columns: 1fr;
            }
        }

        .build-order-column {
            min-width: 0;
        }

        /* Player theme - blue/purple */
        #playerBuildOrderColumn .build-order-item {
            border-left: 3px solid #667eea;
        }

        #playerBuildOrderColumn .build-order-time {
            color: #667eea;
        }

        /* Opponent theme - red */
        #opponentBuildOrderColumn .build-order-item {
            border-left: 3px solid #e74c3c;
        }

        #opponentBuildOrderColumn .build-order-time {
            color: #e74c3c;
        }

        .timing-comparison {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #0f3460;
            border-radius: 8px;
        }

        .timing-comparison-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }

        .timing-winner {
            font-size: 0.85rem;
            color: #27ae60;
        }

        .timing-loser {
            font-size: 0.85rem;
            color: #e74c3c;
        }

        /* Rubric Coaching Styles */
        .rubric-coaching-card {
            background: #16213e;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .rubric-selector {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            margin-bottom: 1rem;
        }

        .rubric-selector select {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #0f3460;
            border-radius: 8px;
            background: #0f3460;
            color: #fff;
            font-size: 1rem;
        }

        .benchmark-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #0f3460;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }

        .benchmark-metric {
            flex: 1;
            font-weight: bold;
        }

        .benchmark-times {
            flex: 2;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.9rem;
        }

        .benchmark-rating {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .rating-excellent {
            background: #27ae60;
            color: white;
        }

        .rating-good {
            background: #3498db;
            color: white;
        }

        .rating-average {
            background: #f39c12;
            color: white;
        }

        .rating-poor {
            background: #e67e22;
            color: white;
        }

        .rating-very_poor {
            background: #e74c3c;
            color: white;
        }

        .mistake-item {
            background: #0f3460;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #f39c12;
        }

        .mistake-item h4 {
            color: #f39c12;
            margin-bottom: 0.5rem;
        }

        .mistake-item p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        .mistake-item .evidence {
            color: #888;
            font-style: italic;
        }

        .criteria-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #0f3460;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .criteria-check {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .criteria-text {
            flex: 1;
        }

        .criteria-notes {
            color: #888;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .coaching-loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .civ-mismatch-warning {
            background: #f39c12;
            color: #1a1a2e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè∞ AoE IV AI Coach</h1>
        <p>AI-powered performance analysis using AoE4 World data</p>
    </div>
    
    <div class="container">
        <!-- Input Section -->
        <div class="input-section" id="inputSection">
            <h2 style="margin-bottom: 1rem;">Enter Your Player ID or Game URL</h2>

            <div class="input-group">
                <div class="input-field">
                    <label for="profileId">Steam ID, Profile ID, or AoE4 World URL</label>
                    <input type="text" id="profileId" placeholder="e.g., 4635035 or https://aoe4world.com/players/17689761/games/182257348?sig=..." value="">
                </div>
                
                <div class="input-field" style="flex: 0.5;">
                    <label for="gameMode">Game Mode</label>
                    <select id="gameMode">
                        <option value="rm_solo">Ranked Solo</option>
                        <option value="rm_team">Ranked Team</option>
                        <option value="qm_1v1">Quick Match 1v1</option>
                        <option value="qm_2v2">Quick Match 2v2</option>
                    </select>
                </div>
                
                <div class="input-field" style="flex: 0.3;">
                    <label for="gameLimit">Games</label>
                    <input type="number" id="gameLimit" value="10" min="1" max="50">
                </div>
                
                <button class="btn" onclick="analyzePlayer()">Analyze</button>
            </div>
            
            <p class="help-text">
                üí° Find your Profile ID on <a href="https://aoe4world.com" target="_blank" style="color: #667eea;">AoE4 World</a> by searching your Steam name<br>
                üîó Or paste a game URL from AoE4 World to analyze a specific match
            </p>

            <div class="warning" id="warning"></div>
            <div class="error" id="error"></div>
            
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #0f3460;">
                <button class="btn btn-secondary" onclick="loadDemo()">üéÆ Load Demo Report</button>
            </div>
        </div>
        
        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing your games...</p>
        </div>
        
        <!-- Results Section -->
        <div class="results" id="results">
            <!-- Player Header -->
            <div class="card">
                <div class="player-header">
                    <div class="player-avatar" id="playerAvatar">üë§</div>
                    <div class="player-info">
                        <h3 id="playerName">Player Name</h3>
                        <p id="playerId">Profile ID: -</p>
                    </div>
                </div>
            </div>
            
            <!-- Performance Overview -->
            <div class="card">
                <h2>üìä Performance Overview</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <h3>Rating</h3>
                        <div class="value" id="currentRating">-</div>
                        <div class="sub" id="ratingTrend"></div>
                    </div>
                    <div class="stat-box">
                        <h3>Win Rate</h3>
                        <div class="value" id="winRate">-</div>
                        <div class="sub" id="winLossRecord"></div>
                    </div>
                    <div class="stat-box">
                        <h3>Games</h3>
                        <div class="value" id="totalGames">-</div>
                        <div class="sub">analyzed</div>
                    </div>
                    <div class="stat-box">
                        <h3>Coach Rating</h3>
                        <div class="value" id="coachRating" style="color: #f39c12;">-</div>
                        <div class="sub">AI assessment</div>
                    </div>
                </div>
            </div>
            
            <!-- AI Rating -->
            <div class="card">
                <h2>üéØ AI Performance Rating</h2>
                <div class="rating" id="ratingBig">-</div>
                <p style="text-align: center; color: #a0a0a0;" id="ratingDescription">
                    Based on your recent match history
                </p>
            </div>
            
            <!-- Charts -->
            <div class="card">
                <h2>üìà Civilization Performance</h2>
                <div class="chart-container">
                    <canvas id="civChart"></canvas>
                </div>
            </div>
            
            <!-- Recent Games -->
            <div class="card">
                <h2>üéÆ Recent Games</h2>
                <div class="games-list" id="gamesList"></div>
            </div>
            
            <!-- Strengths -->
            <div class="card">
                <h2>üí™ Strengths</h2>
                <div id="strengthsList"></div>
            </div>
            
            <!-- Improvements -->
            <div class="card">
                <h2>üîß Areas for Improvement</h2>
                <div id="improvementsList"></div>
            </div>
            
            <!-- Civilization Recommendations -->
            <div class="card">
                <h2>üèõÔ∏è Civilization Recommendations</h2>
                <ul id="civRecommendations" style="padding-left: 1.5rem; line-height: 2;"></ul>
            </div>
            
            <!-- Map Advice -->
            <div class="card">
                <h2>üó∫Ô∏è Map Advice</h2>
                <ul id="mapAdvice" style="padding-left: 1.5rem; line-height: 2;"></ul>
            </div>
            
            <!-- Training Plan -->
            <div class="card">
                <h2>üìö Training Plan</h2>
                <ul id="trainingList" style="padding-left: 1.5rem; line-height: 2;"></ul>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="showInputSection()">‚Üê Back to Input</button>
            </div>
        </div>

        <!-- Build Order View -->
        <div class="build-order-view" id="buildOrderView">
            <!-- Game Header -->
            <div class="card">
                <div class="game-header">
                    <div class="game-header-left">
                        <h3 id="bo-map">Map</h3>
                        <p style="color: #888;"><span id="bo-duration">--:--</span> ‚Ä¢ <span id="bo-result">Result</span></p>
                    </div>
                    <div class="game-header-right">
                        <p style="color: #888;">Game ID: <span id="bo-gameId">-</span></p>
                    </div>
                </div>

                <!-- Matchup -->
                <div class="matchup">
                    <div class="matchup-player">
                        <h3 id="bo-playerName">Player</h3>
                        <p style="color: #667eea; font-size: 1.1rem;" id="bo-playerCiv">Civilization</p>
                        <p style="color: #888;">Rating: <span id="bo-playerRating">-</span></p>
                    </div>
                    <div class="matchup-vs">VS</div>
                    <div class="matchup-player">
                        <h3 id="bo-opponentName">Opponent</h3>
                        <p style="color: #e74c3c; font-size: 1.1rem;" id="bo-opponentCiv">Civilization</p>
                        <p style="color: #888;">Rating: <span id="bo-opponentRating">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Age Up Timings -->
            <div class="card">
                <h2>‚è±Ô∏è Age Up Timings</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <h3>Feudal Age</h3>
                        <div class="value" id="bo-feudalTime">-</div>
                    </div>
                    <div class="stat-box">
                        <h3>Castle Age</h3>
                        <div class="value" id="bo-castleTime">-</div>
                    </div>
                    <div class="stat-box">
                        <h3>Imperial Age</h3>
                        <div class="value" id="bo-imperialTime">-</div>
                    </div>
                </div>
            </div>

            <!-- Performance Stats -->
            <div class="card">
                <h2>üìä Performance Stats</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <h3>APM</h3>
                        <div class="value" id="bo-apm">-</div>
                    </div>
                    <div class="stat-box">
                        <h3>Villagers</h3>
                        <div class="value" id="bo-villagers">-</div>
                        <div class="sub">peak count</div>
                    </div>
                    <div class="stat-box">
                        <h3>Military</h3>
                        <div class="value" id="bo-military">-</div>
                        <div class="sub">units created</div>
                    </div>
                </div>
            </div>

            <!-- Build Order Timeline -->
            <div class="card">
                <h2>üìú Build Order</h2>

                <!-- Timing Comparison -->
                <div class="timing-comparison" id="timingComparison">
                    <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">‚öîÔ∏è Age Up Comparison</h3>
                    <div class="timing-comparison-row">
                        <span>Feudal Age:</span>
                        <span id="comp-feudal-player">-</span>
                        <span>vs</span>
                        <span id="comp-feudal-opponent">-</span>
                        <span id="comp-feudal-winner" class="timing-winner"></span>
                    </div>
                    <div class="timing-comparison-row">
                        <span>Castle Age:</span>
                        <span id="comp-castle-player">-</span>
                        <span>vs</span>
                        <span id="comp-castle-opponent">-</span>
                        <span id="comp-castle-winner" class="timing-winner"></span>
                    </div>
                    <div class="timing-comparison-row">
                        <span>Imperial Age:</span>
                        <span id="comp-imperial-player">-</span>
                        <span>vs</span>
                        <span id="comp-imperial-opponent">-</span>
                        <span id="comp-imperial-winner" class="timing-winner"></span>
                    </div>
                </div>

                <!-- Side-by-side Build Orders -->
                <div class="build-order-container">
                    <!-- Player Build Order -->
                    <div class="build-order-column" id="playerBuildOrderColumn">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">
                            <span id="player-column-name">Your Build Order</span>
                        </h3>
                        <div class="build-order-timeline" id="buildOrderTimeline">
                            <!-- Player timeline items -->
                        </div>
                    </div>

                    <!-- Opponent Build Order -->
                    <div class="build-order-column" id="opponentBuildOrderColumn">
                        <h3 style="color: #e74c3c; margin-bottom: 1rem;">
                            <span id="opponent-column-name">Opponent Build Order</span>
                        </h3>
                        <div class="build-order-timeline" id="opponentBuildOrderTimeline">
                            <!-- Opponent timeline items -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rubric Coaching Card -->
            <div class="card rubric-coaching-card">
                <h2>üéØ Build Order Coaching</h2>
                <p style="color: #888; margin-bottom: 1rem;">
                    Compare your execution against professional build order rubrics
                </p>

                <!-- Rubric Selector -->
                <div class="rubric-selector">
                    <div class="input-field" style="flex: 1;">
                        <label for="rubricSelect">Select Build Order Rubric</label>
                        <select id="rubricSelect">
                            <option value="">Loading rubrics...</option>
                        </select>
                    </div>
                    <button class="btn" onclick="analyzeWithRubric()">Generate Coaching</button>
                </div>

                <!-- Civilization Mismatch Warning -->
                <div class="civ-mismatch-warning" id="civMismatchWarning"></div>

                <!-- Loading State -->
                <div class="coaching-loading" id="coachingLoading">
                    <div class="spinner"></div>
                    <p>Analyzing your game against the rubric...</p>
                </div>

                <!-- Coaching Results -->
                <div id="coachingResults" style="display: none;">
                    <!-- Overall Assessment -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="color: #667eea; margin-bottom: 0.5rem;">Overall Assessment</h3>
                        <p id="coaching-assessment" style="line-height: 1.6;"></p>
                    </div>

                    <!-- Benchmark Comparison -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="color: #667eea; margin-bottom: 0.75rem;">Benchmark Comparison</h3>
                        <div id="coaching-benchmarks"></div>
                    </div>

                    <!-- Execution Mistakes -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="color: #667eea; margin-bottom: 0.75rem;">Execution Mistakes</h3>
                        <div id="coaching-mistakes"></div>
                    </div>

                    <!-- Success Criteria -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="color: #667eea; margin-bottom: 0.75rem;">Success Criteria Evaluation</h3>
                        <div id="coaching-criteria"></div>
                    </div>

                    <!-- Improvement Suggestions -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="color: #667eea; margin-bottom: 0.75rem;">Improvement Suggestions</h3>
                        <ol id="coaching-suggestions" style="padding-left: 1.5rem; line-height: 2;"></ol>
                    </div>

                    <!-- Strategic Advice -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="color: #667eea; margin-bottom: 0.75rem;">Strategic Advice</h3>
                        <div id="coaching-advice" style="line-height: 1.8; white-space: pre-line;"></div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="showInputSection()">‚Üê Back to Input</button>
            </div>
        </div>
    </div>
    
    <script>
        // Auto-detect API URL - works both with separate frontend server and integrated backend
        const API_URL = window.location.port === '8000' || window.location.pathname.includes('/static/')
            ? ''  // Same origin (integrated mode)
            : 'http://localhost:8000';  // Separate frontend server
        let civChart = null;
        let currentGameData = { profileId: null, gameId: null, signature: null };

        // Parse AoE4 World URL or plain ID
        function parseAoE4WorldUrl(input) {
            input = input.trim();

            // URL patterns (handle optional player name like "17689761-flyeversheep")
            const patterns = {
                gameWithSig: /aoe4world\.com\/players\/(\d+)(?:-[^/]+)?\/games\/(\d+)\?sig=([a-f0-9]+)/i,
                game: /aoe4world\.com\/players\/(\d+)(?:-[^/]+)?\/games\/(\d+)/i,
                profile: /aoe4world\.com\/players\/(\d+)(?:-[^/]+)?/i,
                plainId: /^(\d+)$/
            };

            // Check game URL with signature (priority)
            let match = input.match(patterns.gameWithSig);
            if (match) {
                return {
                    type: 'game',
                    profileId: match[1],
                    gameId: match[2],
                    signature: match[3],
                    hasSig: true
                };
            }

            // Check game URL without signature
            match = input.match(patterns.game);
            if (match) {
                return {
                    type: 'game',
                    profileId: match[1],
                    gameId: match[2],
                    signature: null,
                    hasSig: false
                };
            }

            // Check profile URL
            match = input.match(patterns.profile);
            if (match) {
                return {
                    type: 'profile',
                    profileId: match[1]
                };
            }

            // Check plain ID
            match = input.match(patterns.plainId);
            if (match) {
                return {
                    type: 'plain_id',
                    profileId: match[1]
                };
            }

            return {
                type: 'invalid',
                error: 'Invalid URL format. Please enter a valid AoE4 World URL or Profile ID.'
            };
        }

        // Format seconds to MM:SS
        function formatTime(seconds) {
            if (!seconds && seconds !== 0) return '-';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Show warning message
        function showWarning(message) {
            const warningEl = document.getElementById('warning');
            warningEl.textContent = '‚ö†Ô∏è ' + message;
            warningEl.style.display = 'block';
        }

        // Hide warning message
        function hideWarning() {
            document.getElementById('warning').style.display = 'none';
        }

        // Show input section
        function showInputSection() {
            document.getElementById('inputSection').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('results').style.display = 'none';
            document.getElementById('buildOrderView').style.display = 'none';
        }

        // Analyze game build order
        async function analyzeGame(profileId, gameId, signature) {
            hideError();
            hideWarning();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('buildOrderView').style.display = 'none';

            // Store current game data for rubric coaching
            currentGameData = { profileId, gameId, signature };

            try {
                const url = signature
                    ? `${API_URL}/api/game/${profileId}/${gameId}?sig=${signature}`
                    : `${API_URL}/api/game/${profileId}/${gameId}`;

                const response = await fetch(url);

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Game not found or private. Make sure the URL includes the signature parameter.');
                    }
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to fetch game data');
                }

                const data = await response.json();
                displayBuildOrderResults(data);
            } catch (error) {
                showError(error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Display build order results
        function displayBuildOrderResults(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('buildOrderView').style.display = 'block';

            const game = data.game;
            const player = data.player;
            const opponent = data.opponent;
            const timings = data.timings || {};
            const buildOrder = data.build_order || [];
            const opponentBuildOrder = data.opponent_build_order || [];

            // Game header
            document.getElementById('bo-map').textContent = game.map || 'Unknown Map';
            document.getElementById('bo-duration').textContent = game.duration_formatted || formatTime(game.duration);
            document.getElementById('bo-gameId').textContent = game.game_id || '-';

            const resultEl = document.getElementById('bo-result');
            if (player.result === 'win') {
                resultEl.textContent = '‚úÖ Victory';
                resultEl.style.color = '#27ae60';
            } else if (player.result === 'loss') {
                resultEl.textContent = '‚ùå Defeat';
                resultEl.style.color = '#e74c3c';
            } else {
                resultEl.textContent = player.result || 'Unknown';
                resultEl.style.color = '#888';
            }

            // Matchup
            document.getElementById('bo-playerName').textContent = player.name || 'Player';
            document.getElementById('bo-playerCiv').textContent = player.civilization || '-';
            document.getElementById('bo-playerRating').textContent = player.rating || '-';

            document.getElementById('bo-opponentName').textContent = opponent.name || 'Opponent';
            document.getElementById('bo-opponentCiv').textContent = opponent.civilization || '-';
            document.getElementById('bo-opponentRating').textContent = opponent.rating || '-';

            // Age timings (now using player timings)
            const playerTimings = timings.player || {};
            document.getElementById('bo-feudalTime').textContent =
                playerTimings.feudal_age?.formatted || formatTime(playerTimings.feudal_age?.seconds) || '-';
            document.getElementById('bo-castleTime').textContent =
                playerTimings.castle_age?.formatted || formatTime(playerTimings.castle_age?.seconds) || '-';
            document.getElementById('bo-imperialTime').textContent =
                playerTimings.imperial_age?.formatted || formatTime(playerTimings.imperial_age?.seconds) || '-';

            // Performance stats
            document.getElementById('bo-apm').textContent = player.apm || '-';
            document.getElementById('bo-villagers').textContent = player.villager_high || '-';
            document.getElementById('bo-military').textContent = player.military_count || '-';

            // Update player column name
            document.getElementById('player-column-name').textContent =
                `${player.name || 'You'} (${player.civilization || '-'})`;

            // Update opponent column name
            document.getElementById('opponent-column-name').textContent =
                `${opponent.name || 'Opponent'} (${opponent.civilization || '-'})`;

            // Render timing comparison
            updateTimingComparison(timings);

            // Render player build order timeline
            renderBuildOrderTimeline('buildOrderTimeline', buildOrder);

            // Render opponent build order timeline
            renderBuildOrderTimeline('opponentBuildOrderTimeline', opponentBuildOrder);

            // Scroll to results
            document.getElementById('buildOrderView').scrollIntoView({ behavior: 'smooth' });
        }

        function updateTimingComparison(timings) {
            const player = timings.player || {};
            const opponent = timings.opponent || {};

            // Feudal Age
            updateTimingRow('feudal', player.feudal_age, opponent.feudal_age);
            // Castle Age
            updateTimingRow('castle', player.castle_age, opponent.castle_age);
            // Imperial Age
            updateTimingRow('imperial', player.imperial_age, opponent.imperial_age);
        }

        function updateTimingRow(age, playerData, opponentData) {
            const playerTime = playerData?.formatted || '-';
            const opponentTime = opponentData?.formatted || '-';
            const playerSeconds = playerData?.seconds;
            const opponentSeconds = opponentData?.seconds;

            document.getElementById(`comp-${age}-player`).textContent = playerTime;
            document.getElementById(`comp-${age}-opponent`).textContent = opponentTime;

            const winnerEl = document.getElementById(`comp-${age}-winner`);

            if (playerSeconds && opponentSeconds) {
                const diff = playerSeconds - opponentSeconds;
                if (diff < 0) {
                    winnerEl.textContent = `‚úì ${Math.abs(diff)}s faster`;
                    winnerEl.className = 'timing-winner';
                } else if (diff > 0) {
                    winnerEl.textContent = `${diff}s slower`;
                    winnerEl.className = 'timing-loser';
                } else {
                    winnerEl.textContent = 'Same time';
                    winnerEl.className = '';
                    winnerEl.style.color = '#888';
                }
            } else {
                winnerEl.textContent = '';
            }
        }

        function renderBuildOrderTimeline(elementId, buildOrder) {
            const timeline = document.getElementById(elementId);

            if (!buildOrder || buildOrder.length === 0) {
                timeline.innerHTML = '<p style="color: #888; text-align: center;">No build order data available</p>';
                return;
            }

            // Process build order items to create timeline entries
            const timelineItems = [];

            buildOrder.forEach(item => {
                // Use enriched name from API if available, fall back to icon extraction
                const itemName = item.name || (item.icon ? item.icon.split('/').pop().replace(/_/g, ' ') : item.type);

                // Add constructed events
                if (item.constructed && item.constructed.length > 0) {
                    item.constructed.forEach(time => {
                        timelineItems.push({
                            time: time,
                            action: `Started ${itemName}`,
                            type: item.type
                        });
                    });
                }

                // Add finished events (units created, buildings completed)
                if (item.finished && item.finished.length > 0) {
                    item.finished.forEach((time, index) => {
                        timelineItems.push({
                            time: time,
                            action: `${itemName}`,
                            count: item.finished.length > 1 ? `#${index + 1}` : '',
                            type: item.type
                        });
                    });
                }
            });

            // Sort by time and limit to reasonable amount
            timelineItems.sort((a, b) => a.time - b.time);
            const displayItems = timelineItems.slice(0, 200);

            timeline.innerHTML = displayItems.map(item => `
                <div class="build-order-item">
                    <div class="build-order-time">${formatTime(item.time)}</div>
                    <div class="build-order-action">${item.action}</div>
                    <div class="build-order-count">${item.count || ''}</div>
                </div>
            `).join('');
        }

        async function analyzePlayer() {
            const input = document.getElementById('profileId').value.trim();
            const gameMode = document.getElementById('gameMode').value;
            const gameLimit = document.getElementById('gameLimit').value;

            if (!input) {
                showError('Please enter a Profile ID or AoE4 World URL');
                return;
            }

            hideError();
            hideWarning();

            // Parse input
            const parsed = parseAoE4WorldUrl(input);

            if (parsed.type === 'invalid') {
                showError(parsed.error);
                return;
            }

            // Route based on input type
            if (parsed.type === 'game') {
                // Show warning if no signature
                if (!parsed.hasSig) {
                    showWarning('This game URL does not include a signature. It may not work for private games.');
                }
                // Analyze specific game
                await analyzeGame(parsed.profileId, parsed.gameId, parsed.signature);
            } else if (parsed.type === 'profile' || parsed.type === 'plain_id') {
                // Analyze player (existing functionality)
                const profileId = parsed.profileId;

                document.getElementById('loading').style.display = 'block';
                document.getElementById('results').style.display = 'none';
                document.getElementById('buildOrderView').style.display = 'none';

                try {
                    const response = await fetch(
                        `${API_URL}/api/player/${profileId}?leaderboard=${gameMode}&limit=${gameLimit}`
                    );

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Failed to fetch player data');
                    }

                    const data = await response.json();
                    displayResults(data);
                } catch (error) {
                    showError(error.message);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }
        }
        
        async function loadDemo() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            hideError();
            
            try {
                const response = await fetch(`${API_URL}/api/sample-report`);
                const sampleData = await response.json();
                
                // Create mock data structure matching API response
                const mockData = {
                    player: {
                        name: "DemoPlayer",
                        profile_id: 12345,
                        country: "US"
                    },
                    analysis: {
                        total_games: 10,
                        wins: 6,
                        losses: 4,
                        win_rate: 60,
                        current_rating: 1200,
                        civilization_stats: {
                            "English": { games: 5, wins: 4, win_rate: 80 },
                            "French": { games: 3, wins: 1, win_rate: 33 },
                            "Delhi": { games: 2, wins: 1, win_rate: 50 }
                        },
                        map_stats: {
                            "Arabia": { games: 4, wins: 3, win_rate: 75 },
                            "Black Forest": { games: 3, wins: 1, win_rate: 33 },
                            "Archipelago": { games: 3, wins: 2, win_rate: 67 }
                        }
                    },
                    recent_games: [
                        { map: "Arabia", civilization: "English", result: "win", rating: 1215, rating_diff: 15, opponent: { name: "Opponent1", civilization: "French", rating: 1180 } },
                        { map: "Black Forest", civilization: "French", result: "loss", rating: 1200, rating_diff: -15, opponent: { name: "Opponent2", civilization: "English", rating: 1220 } }
                    ],
                    coaching_report: sampleData
                };
                
                displayResults(mockData);
            } catch (error) {
                showError('Failed to load demo: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function displayResults(data) {
            document.getElementById('results').style.display = 'block';
            
            const player = data.player;
            const analysis = data.analysis;
            const report = data.coaching_report;
            const games = data.recent_games;
            
            // Update player header
            document.getElementById('playerName').textContent = player.name;
            document.getElementById('playerId').textContent = `Profile ID: ${player.profile_id}`;
            if (player.avatar_url) {
                document.getElementById('playerAvatar').innerHTML = `<img src="${player.avatar_url}" alt="${player.name}">`;
            }
            
            // Update stats
            document.getElementById('currentRating').textContent = analysis.current_rating || '-';
            document.getElementById('winRate').textContent = (analysis.win_rate || 0) + '%';
            document.getElementById('totalGames').textContent = analysis.total_games || '-';
            document.getElementById('coachRating').textContent = report.rating || '-';
            document.getElementById('ratingBig').textContent = report.rating || '-';
            
            document.getElementById('winLossRecord').textContent = 
                `${analysis.wins || 0}W - ${analysis.losses || 0}L`;
            
            const ratingDiff = analysis.avg_rating_change;
            if (ratingDiff > 0) {
                document.getElementById('ratingTrend').textContent = `+${ratingDiff} avg`;
                document.getElementById('ratingTrend').style.color = '#27ae60';
            } else if (ratingDiff < 0) {
                document.getElementById('ratingTrend').textContent = `${ratingDiff} avg`;
                document.getElementById('ratingTrend').style.color = '#e74c3c';
            }
            
            // Render games list
            const gamesList = document.getElementById('gamesList');
            gamesList.innerHTML = games.map(g => `
                <div class="game-item ${g.result}">
                    <div class="game-info">
                        <h4>${g.civilization} vs ${g.opponent.civilization}</h4>
                        <p>${g.map} ‚Ä¢ vs ${g.opponent.name} (${g.opponent.rating})</p>
                    </div>
                    <div class="game-result">
                        <div class="result ${g.result}">${g.result.toUpperCase()}</div>
                        <div class="rating">${g.rating} (${g.rating_diff > 0 ? '+' : ''}${g.rating_diff})</div>
                    </div>
                </div>
            `).join('');
            
            // Render strengths
            const strengthsList = document.getElementById('strengthsList');
            strengthsList.innerHTML = (report.strengths || []).map(s => 
                `<div class="strength-item">‚úÖ ${s}</div>`
            ).join('');
            
            // Render improvements
            const improvementsList = document.getElementById('improvementsList');
            improvementsList.innerHTML = (report.improvements || []).map(imp => 
                `<div class="improvement-item">
                    <h4>${imp.issue || imp}</h4>
                    ${imp.impact ? `<p><strong>Impact:</strong> ${imp.impact}</p>` : ''}
                    ${imp.fix ? `<p><strong>Fix:</strong> ${imp.fix}</p>` : ''}
                </div>`
            ).join('');
            
            // Render recommendations
            document.getElementById('civRecommendations').innerHTML = 
                (report.civ_recommendations || []).map(r => `<li>${r}</li>`).join('');
            
            document.getElementById('mapAdvice').innerHTML = 
                (report.map_advice || []).map(a => `<li>${a}</li>`).join('');
            
            document.getElementById('trainingList').innerHTML = 
                (report.training_plan || []).map(t => `<li>${t}</li>`).join('');
            
            // Render chart
            renderCivChart(analysis.civilization_stats);
            
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }
        
        function renderCivChart(civStats) {
            const ctx = document.getElementById('civChart').getContext('2d');
            
            const civs = Object.keys(civStats || {});
            const winRates = civs.map(c => civStats[c].win_rate);
            const games = civs.map(c => civStats[c].games);
            
            if (civChart) {
                civChart.destroy();
            }
            
            civChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: civs,
                    datasets: [{
                        label: 'Win Rate (%)',
                        data: winRates,
                        backgroundColor: winRates.map(w => w >= 50 ? '#27ae60' : '#e74c3c'),
                        borderColor: winRates.map(w => w >= 50 ? '#27ae60' : '#e74c3c'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: '#333' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#a0a0a0' },
                            grid: { color: '#333' }
                        }
                    }
                }
            });
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // ============================================================================
        // Rubric Coaching Functions
        // ============================================================================

        async function loadRubrics() {
            try {
                const response = await fetch(`${API_URL}/api/rubrics`);
                if (!response.ok) {
                    throw new Error('Failed to load rubrics');
                }

                const data = await response.json();
                const rubrics = data.rubrics || [];

                const select = document.getElementById('rubricSelect');
                select.innerHTML = '<option value="">Select a rubric...</option>';

                rubrics.forEach(rubric => {
                    const option = document.createElement('option');
                    option.value = rubric.id;
                    option.textContent = `${rubric.title} (${rubric.difficulty})`;
                    select.appendChild(option);
                });

                console.log(`Loaded ${rubrics.length} rubrics`);
            } catch (error) {
                console.error('Failed to load rubrics:', error);
                document.getElementById('rubricSelect').innerHTML = '<option value="">Failed to load rubrics</option>';
            }
        }

        async function analyzeWithRubric() {
            const rubricId = document.getElementById('rubricSelect').value;

            if (!rubricId) {
                alert('Please select a rubric first');
                return;
            }

            if (!currentGameData.profileId || !currentGameData.gameId) {
                alert('No game loaded. Please analyze a game first.');
                return;
            }

            // Show loading state
            document.getElementById('coachingLoading').style.display = 'block';
            document.getElementById('coachingResults').style.display = 'none';
            document.getElementById('civMismatchWarning').style.display = 'none';

            try {
                const url = currentGameData.signature
                    ? `${API_URL}/api/game/${currentGameData.profileId}/${currentGameData.gameId}/coaching?rubric_id=${rubricId}&sig=${currentGameData.signature}`
                    : `${API_URL}/api/game/${currentGameData.profileId}/${currentGameData.gameId}/coaching?rubric_id=${rubricId}`;

                const response = await fetch(url, { method: 'POST' });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate coaching');
                }

                const data = await response.json();
                displayRubricCoaching(data);
            } catch (error) {
                alert('Failed to generate coaching: ' + error.message);
                console.error('Coaching error:', error);
            } finally {
                document.getElementById('coachingLoading').style.display = 'none';
            }
        }

        function displayRubricCoaching(data) {
            const coaching = data.coaching || {};

            // Show civilization mismatch warning
            if (data.civ_mismatch) {
                const warning = document.getElementById('civMismatchWarning');
                warning.textContent = `‚ö†Ô∏è Note: This rubric is designed for ${data.rubric.civilizations.join(', ')}, but you played ${data.game.player_civilization}. The analysis will still provide useful insights.`;
                warning.style.display = 'block';
            }

            // Overall Assessment
            document.getElementById('coaching-assessment').textContent =
                coaching.overall_assessment || 'No assessment available.';

            // Benchmark Comparison
            const benchmarks = coaching.benchmark_comparison || [];
            const benchmarksHtml = benchmarks.map(b => {
                const ratingClass = `rating-${b.rating}`;
                const delta = b.delta_seconds || 0;
                const deltaText = delta > 0 ? `+${delta}s slower` : delta < 0 ? `${Math.abs(delta)}s faster` : 'on time';

                return `
                    <div class="benchmark-item">
                        <div class="benchmark-metric">${b.metric}</div>
                        <div class="benchmark-times">
                            <span>Expected: <strong>${b.expected}</strong></span>
                            <span>‚Üí</span>
                            <span>Actual: <strong>${b.actual}</strong></span>
                            <span style="color: #888;">(${deltaText})</span>
                        </div>
                        <div class="benchmark-rating ${ratingClass}">${b.rating}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('coaching-benchmarks').innerHTML =
                benchmarksHtml || '<p style="color: #888;">No benchmark data available.</p>';

            // Execution Mistakes
            const mistakes = coaching.execution_mistakes || [];
            const mistakesHtml = mistakes.map(m => `
                <div class="mistake-item">
                    <h4>${m.mistake}</h4>
                    ${m.evidence ? `<p class="evidence">Evidence: ${m.evidence}</p>` : ''}
                    ${m.consequence ? `<p><strong>Consequence:</strong> ${m.consequence}</p>` : ''}
                    ${m.fix ? `<p><strong>Fix:</strong> ${m.fix}</p>` : ''}
                </div>
            `).join('');
            document.getElementById('coaching-mistakes').innerHTML =
                mistakesHtml || '<p style="color: #888;">No specific mistakes identified.</p>';

            // Success Criteria
            const criteria = coaching.success_criteria_evaluation || [];
            const criteriaHtml = criteria.map(c => {
                const checkIcon = c.met ? '‚úÖ' : '‚ùå';
                return `
                    <div class="criteria-item">
                        <div class="criteria-check">${checkIcon}</div>
                        <div class="criteria-text">
                            <div>${c.criterion}</div>
                            ${c.notes ? `<div class="criteria-notes">${c.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('coaching-criteria').innerHTML =
                criteriaHtml || '<p style="color: #888;">No criteria evaluation available.</p>';

            // Improvement Suggestions
            const suggestions = coaching.improvement_suggestions || [];
            const suggestionsHtml = suggestions.map(s => `<li>${s}</li>`).join('');
            document.getElementById('coaching-suggestions').innerHTML =
                suggestionsHtml || '<li style="color: #888;">No suggestions available.</li>';

            // Strategic Advice
            document.getElementById('coaching-advice').textContent =
                coaching.open_ended_advice || 'No strategic advice available.';

            // Show results
            document.getElementById('coachingResults').style.display = 'block';

            // Scroll to coaching card
            document.querySelector('.rubric-coaching-card').scrollIntoView({ behavior: 'smooth' });
        }

        // Load rubrics when page loads
        window.addEventListener('DOMContentLoaded', () => {
            loadRubrics();
        });
    </script>
</body>
</html>
